version: "3.9"
services:
  prometheus:
    image: prom/prometheus
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
    ports: ["9090:9090"]

  grafana:
    image: grafana/grafana
    ports: ["3000:3000"]

  app:
    profiles: ["local"]
    build: .
    image: ba-cpu:local
    ports: ["8080:8080", "9091:9091"]

  k6-run:
    image: grafana/k6:1.3.0
    volumes:
      - ./scripts:/scripts:ro
      - ./results:/results
      - ./src/main/proto:/proto:ro
    environment:
      - TARGET=${TARGET}
      - GRPC_TARGET=${GRPC_TARGET}
      - RUN_ID=${RUN_ID}
      - TEST=${TEST}
      - SIZE=${SIZE:-50MB}
      - CHUNK=${CHUNK:-65536}
      - SIZE_MB=${SIZE_MB:-10}
    command:
      - run
      - --tag
      - run_id=${RUN_ID}
      - --tag
      - test=${TEST}
      - --summary-export
      - /results/${RUN_ID}_${TEST}_summary.json
      - -o
      - json=/results/${RUN_ID}_${TEST}_raw.json
      - /scripts/${TEST}.js
